<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JobAssist | Contact Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        /* Layout Container */
        .app-layout-container {
            /* Fix the height to viewport minus navbar */
            height: calc(100vh - 64px); 
            margin-top: 64px; 
        }
        .container-padding {
            padding: 1.5rem 1rem;
        }
        @media (min-width: 640px) {
            .container-padding {
                padding: 2.5rem 2rem;
            }
        }
        /* Loading Spinner */
        .loading-animation {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Table column widths */
        .contact-name-col {
            width: 180px;
            min-width: 180px;
        }
        .position-col {
            width: 280px;
            min-width: 280px;
        }
        .company-col {
            width: 180px;
            min-width: 180px;
        }
        .email-col {
            width: 220px;
            min-width: 220px;
        }
        .date-col {
            width: 140px;
            min-width: 140px;
        }
    </style>
</head>
<body class="min-h-screen">
    
    <div class="flex app-layout-container overflow-hidden">
        
        <div id="sidebar-container" class="w-64 flex-shrink-0 overflow-y-auto bg-white border-r border-gray-200">
            </div>

        <main id="dashboard-content" class="flex-1 overflow-y-auto">
            <div class="container-padding max-w-7xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Contact Dashboard</h2>
                <p class="text-gray-600 mb-8">Directory of professional connections. Click a **Contact Name** to view their profile or a **Company** to manage that entity.</p>

                <div class="bg-white shadow-xl rounded-xl overflow-hidden flex flex-col">
                    
                    <div id="loadingMessage" class="flex justify-center items-center p-10 hidden">
                        <div class="loading-animation mr-3"></div>
                        <p class="text-gray-500">Loading contacts...</p>
                    </div>

                    <div id="errorMessage" class="text-red-600 bg-red-50 p-6 hidden">
                        <p class="font-bold">Error Loading Data:</p>
                        <p id="errorDetail"></p>
                    </div>

                    <div class="overflow-x-auto overflow-y-auto max-h-[70vh]">
                        <table class="min-w-full divide-y divide-gray-200 border-collapse">
                            <thead class="bg-gray-50 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th scope="col" class="px-0 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 bg-gray-50 contact-name-col" onclick="sortTable('last_name')">
                                        Contact Name
                                        <span class="sort-indicator ml-1" data-column="last_name"></span>
                                    </th>
                                    <th scope="col" class="px-0 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 bg-gray-50 max-w-xs position-col" onclick="sortTable('position')">
                                        Position
                                        <span class="sort-indicator ml-1" data-column="position"></span>
                                    </th>
                                    <th scope="col" class="px-0 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 bg-gray-50 company-col" onclick="sortTable('company_name_clean')">
                                        Company
                                        <span class="sort-indicator ml-1" data-column="company_name_clean"></span>
                                    </th>
                                    <th scope="col" class="px-0 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 bg-gray-50 email-col" onclick="sortTable('email_address')">
                                        Email
                                        <span class="sort-indicator ml-1" data-column="email_address"></span>
                                    </th>
                                    <th scope="col" class="px-0 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 bg-gray-50 date-col" onclick="sortTable('connected_on')">
                                        Connected On
                                        <span class="sort-indicator ml-1" data-column="connected_on"></span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="contactTableBody" class="bg-white divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>

                    <p id="noDataMessage" class="p-6 text-center text-gray-500 hidden">
                        No contacts found.
                    </p>
                </div>
            </div>
        </main>
    </div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script type="module" src="navbar.js"></script>
    <script type="module" src="dashboard_sidebar.js"></script>

    <script type="module">
        import { initializeServices, fetchWithGuard, currentUserId } from './core-utils.js';
        import { injectNavbar } from './navbar.js';
        import { renderSidebar } from './dashboard_sidebar.js';

        // MOCK USER
        window.__userId = 'mock-user-428613';

        let contactData = [];
        let currentSort = { column: 'connected_on', direction: 'desc' };

        // Helper: Format Date
        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric'
            });
        };

        const updateSortIndicators = () => {
            document.querySelectorAll('.sort-indicator').forEach(span => span.innerHTML = '');
            const currentSpan = document.querySelector(`.sort-indicator[data-column="${currentSort.column}"]`);
            if (currentSpan) {
                currentSpan.innerHTML = currentSort.direction === 'asc' ? '&#9650;' : '&#9660;';
            }
        };

        const renderTable = (data) => {
            const tbody = document.getElementById('contactTableBody');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                document.getElementById('noDataMessage').classList.remove('hidden');
                return;
            }
            document.getElementById('noDataMessage').classList.add('hidden');

            data.forEach(contact => {
                const row = tbody.insertRow();
                
                // 1. Contact Name (Linked to external URL)
                const cellName = row.insertCell();
                cellName.className = 'px-0 py-4 whitespace-nowrap text-sm font-medium contact-name-col';
                if (contact.url) {
                    // Links to external URL (e.g., Google Search/LinkedIn)
                    cellName.innerHTML = `<a href="${contact.url}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline inline-flex items-center gap-0.5">${contact.first_name} ${contact.last_name}<svg class="w-3 h-3 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg></a>`;
                } else {
                    cellName.textContent = `${contact.first_name} ${contact.last_name}`;
                }

                // 2. Position
                const cellPos = row.insertCell();
                cellPos.className = 'px-0 py-4 text-sm text-gray-700 max-w-xs break-words position-col';
                cellPos.textContent = contact.position || 'N/A';

                // 3. Company (Linked to Management Page)
                const cellCompany = row.insertCell();
                cellCompany.className = 'px-0 py-4 whitespace-nowrap text-sm font-medium company-col';
                
                if (contact.company_id && contact.company_name_clean) {
                    // Construct Management URL: management.html?companyId=123&companyName=EncodedName
                    const mgmtUrl = `management.html?companyId=${contact.company_id}&companyName=${encodeURIComponent(contact.company_name_clean)}`;
                    cellCompany.innerHTML = `<a href="${mgmtUrl}" class="text-primary hover:text-indigo-800 hover:underline">${contact.company_name_clean}</a>`;
                } else {
                    cellCompany.textContent = contact.company_name_clean || contact.raw_company_name || 'N/A';
                }

                // 4. Email
                const cellEmail = row.insertCell();
                cellEmail.className = 'px-0 py-4 whitespace-nowrap text-sm text-gray-600 email-col';
                if(contact.email_address) {
                    cellEmail.innerHTML = `<a href="mailto:${contact.email_address}" class="hover:text-gray-900">${contact.email_address}</a>`;
                } else {
                    cellEmail.textContent = '-';
                }

                // 5. Connected On
                const cellDate = row.insertCell();
                cellDate.className = 'px-0 py-4 whitespace-nowrap text-sm text-gray-500 date-col';
                cellDate.textContent = formatDate(contact.connected_on);
            });

            updateSortIndicators();
        };

        window.sortTable = (column) => {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            contactData.sort((a, b) => {
                let valA, valB;
                const dir = currentSort.direction;

                // Handle composite name sort if sorting by last_name
                if (column === 'last_name') {
                    valA = ((a.last_name || '') + (a.first_name || '')).toLowerCase();
                    valB = ((b.last_name || '') + (b.first_name || '')).toLowerCase();
                } else {
                    valA = (a[column] || '').toString().toLowerCase();
                    valB = (b[column] || '').toString().toLowerCase();
                }

                if (valA < valB) return dir === 'asc' ? -1 : 1;
                if (valA > valB) return dir === 'asc' ? 1 : -1;
                return 0;
            });

            renderTable(contactData);
        };

        const fetchContacts = async () => {
            const loading = document.getElementById('loadingMessage');
            const errorDiv = document.getElementById('errorMessage');
            
            loading.classList.remove('hidden');
            errorDiv.classList.add('hidden');

            try {
                if (!currentUserId) await new Promise(r => setTimeout(r, 50));

                const result = await fetchWithGuard('/api/contacts/all', 'GET', 'Fetch Contacts', {});

                if (result.status === 'success' && Array.isArray(result.contacts)) {
                    contactData = result.contacts;
                    window.sortTable(currentSort.column);
                } else {
                    throw new Error(result.message || 'Invalid data format received.');
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                document.getElementById('errorDetail').textContent = error.message;
                errorDiv.classList.remove('hidden');
                renderTable([]);
            } finally {
                loading.classList.add('hidden');
            }
        };

        const bootApplication = async () => {
            try {
                await initializeServices();
                injectNavbar();
                renderSidebar();
                await fetchContacts();
            } catch (e) {
                console.error("Boot Error", e);
            }
        };

        document.addEventListener('DOMContentLoaded', bootApplication);
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { 'primary': '#4f46e5' }
                }
            }
        }
    </script>
</body>
</html>