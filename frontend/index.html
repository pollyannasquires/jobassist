<!-- FILENAME: index.html | LAST EDITED: 2025-10-24 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JobAssist | Company Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc; /* Light background for the dashboard */
        }
        .container-padding {
            padding: 1.5rem 1rem;
        }
        @media (min-width: 640px) {
            .container-padding {
                padding: 2.5rem 2rem;
            }
        }
        .loading-animation {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6; /* Blue spinner */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">

    <main class="container-padding max-w-7xl mx-auto">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">Company Dashboard</h2>
        <p class="text-gray-600 mb-8">Overview of all standardized company profiles and enriched data. Click a **Clean Name** to go to the Management page.</p>

        <!-- Main Data Container -->
        <div class="bg-white shadow-xl rounded-xl overflow-hidden">
            <div id="loadingMessage" class="flex justify-center items-center p-10 hidden">
                <div class="loading-animation mr-3"></div>
                <p class="text-gray-500">Loading company data...</p>
            </div>

            <div id="errorMessage" class="text-red-600 bg-red-50 p-6 hidden">
                <p class="font-bold">Error Loading Data:</p>
                <p id="errorDetail"></p>
            </div>

            <!-- Table Container -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <!-- Company Name Column -->
                            <th id="header-company_name_clean" scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer select-none hover:bg-gray-100 transition duration-150" onclick="sortTable('company_name_clean')">
                                Clean Company Name
                                <span class="sort-indicator text-gray-400 ml-1" data-column="company_name_clean"></span>
                            </th>
                            <!-- Employee Size Column -->
                            <th id="header-size_employees" scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer select-none hover:bg-gray-100 transition duration-150" onclick="sortTable('size_employees')">
                                Employee Size
                                <span class="sort-indicator text-gray-400 ml-1" data-column="size_employees"></span>
                            </th>
                            <!-- Annual Revenue Column -->
                            <th id="header-annual_revenue" scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer select-none hover:bg-gray-100 transition duration-150" onclick="sortTable('annual_revenue')">
                                Annual Revenue
                                <span class="sort-indicator text-gray-400 ml-1" data-column="annual_revenue"></span>
                            </th>
                            <!-- Target Interest Column -->
                            <th id="header-target_interest" scope="col" class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer select-none hover:bg-gray-100 transition duration-150" onclick="sortTable('target_interest')">
                                Target Interest
                                <span class="sort-indicator text-gray-400 ml-1" data-column="target_interest"></span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="companyTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Data will be injected here by JavaScript -->
                    </tbody>
                </table>
            </div>

            <p id="noDataMessage" class="p-6 text-center text-gray-500 hidden">
                No standardized company profiles found. Please use the Cleanup Tool to map raw names.
            </p>
        </div>
    </main>

    <script>
        // State management for sorting
        let companyData = [];
        let currentSort = { column: 'company_name_clean', direction: 'asc' };

        // Utility: Formats a number with commas (e.g., 150000 -> 150,000)
        const formatNumber = (num) => {
            if (num === null || num === undefined) return 'N/A';
            return num.toLocaleString('en-US');
        };

        // Utility: Formats revenue (e.g., 5.2, 'B' -> $5.2 B)
        const formatRevenue = (revenue, scale) => {
            if (revenue === null || revenue === undefined) return 'N/A';
            return `$${revenue} ${scale || ''}`;
        };

        // Renders the data into the table body
        const renderTable = (data) => {
            const tbody = document.getElementById('companyTableBody');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                document.getElementById('noDataMessage').classList.remove('hidden');
                return;
            }
            document.getElementById('noDataMessage').classList.add('hidden');

            data.forEach(company => {
                const revenueDisplay = formatRevenue(company.annual_revenue, company.revenue_scale);
                const sizeDisplay = formatNumber(company.size_employees);
                const targetDisplay = company.target_interest
                    ? '<svg class="w-5 h-5 text-yellow-500 inline-block align-middle" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.695h3.462c.969 0 1.371 1.24.588 1.81l-2.817 2.042a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.817-2.042a1 1 0 00-1.175 0l-2.817 2.042c-.785.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.05 8.724c-.783-.57-.381-1.81.588-1.81h3.461a1 1 0 00.951-.695l1.07-3.292z" /></svg>' // Star Icon
                    : '';

                const row = tbody.insertRow();
                
                // Clean Company Name (Link to Management)
                let cellName = row.insertCell();
                cellName.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600 hover:text-blue-800 transition duration-150 cursor-pointer';
                cellName.innerHTML = `<a href="management.html?company_id=${company.company_id}" class="hover:underline">${company.company_name_clean}</a>`;

                // Employee Size
                let cellSize = row.insertCell();
                cellSize.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-700';
                cellSize.textContent = sizeDisplay;

                // Annual Revenue
                let cellRevenue = row.insertCell();
                cellRevenue.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-700';
                cellRevenue.textContent = revenueDisplay;

                // Target Interest
                let cellTarget = row.insertCell();
                cellTarget.className = 'px-6 py-4 whitespace-nowrap text-sm text-center';
                cellTarget.innerHTML = targetDisplay;
            });

            updateSortIndicators();
        };

        // Sorts the companyData array and re-renders the table
        const sortTable = (column) => {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            companyData.sort((a, b) => {
                let valA, valB;

                // Special handling for revenue to combine numeric part and scale
                if (column === 'annual_revenue') {
                    // Convert revenue to a comparable value (e.g., 5.2 B -> 5,200,000,000)
                    const getComparableRevenue = (company) => {
                        // Null revenue is already treated as 0 here
                        const val = parseFloat(company.annual_revenue) || 0;
                        const scale = company.revenue_scale;
                        if (scale === 'K') return val * 1e3;
                        if (scale === 'M') return val * 1e6;
                        if (scale === 'B') return val * 1e9;
                        return val; // Default if scale is missing or unknown
                    };
                    valA = getComparableRevenue(a);
                    valB = getComparableRevenue(b);
                } else {
                    // This handles all other columns: company_name_clean, size_employees, target_interest
                    if (column === 'size_employees') {
                        // Per user request: treat null (N/A) as 0 for numeric size sorting
                        valA = a[column] === null ? 0 : a[column];
                        valB = b[column] === null ? 0 : b[column];
                    } else {
                        // For non-numeric columns (strings/booleans), continue to sort nulls to the ends
                        // by using -Infinity/Infinity based on sort direction
                        valA = a[column] === null ? (currentSort.direction === 'asc' ? -Infinity : Infinity) : a[column];
                        valB = b[column] === null ? (currentSort.direction === 'asc' ? -Infinity : Infinity) : b[column];
                    }
                }
                
                // Default comparison for strings, numbers, and booleans
                if (valA < valB) {
                    return currentSort.direction === 'asc' ? -1 : 1;
                }
                if (valA > valB) {
                    return currentSort.direction === 'asc' ? 1 : -1;
                }
                return 0;
            });

            renderTable(companyData);
        };

        // Updates the visual indicators (arrows) in the table headers
        const updateSortIndicators = () => {
            document.querySelectorAll('.sort-indicator').forEach(span => {
                span.innerHTML = '';
            });

            const currentSpan = document.querySelector(`.sort-indicator[data-column="${currentSort.column}"]`);
            if (currentSpan) {
                currentSpan.innerHTML = currentSort.direction === 'asc' ? '&#9650;' : '&#9660;'; // Up/Down Triangles
            }
        };

        // Main function to fetch data
        const fetchCompanies = async () => {
            const loading = document.getElementById('loadingMessage');
            const errorDiv = document.getElementById('errorMessage');
            loading.classList.remove('hidden');
            errorDiv.classList.add('hidden');

            try {
                // Implementing exponential backoff for robustness
                const maxRetries = 3;
                let response = null;

                for (let attempt = 0; attempt < maxRetries; attempt++) {
                    response = await fetch('/api/companies');
                    if (response.ok) {
                        break;
                    }
                    if (attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error(`Failed to fetch data after ${maxRetries} attempts. Status: ${response.status}`);
                    }
                }

                const result = await response.json();

                if (result.status === 'success' && Array.isArray(result.companies)) {
                    companyData = result.companies;
                    // Initial sort by clean name (default)
                    sortTable(currentSort.column);
                } else {
                    throw new Error(result.message || 'API returned a non-success status or malformed data.');
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                document.getElementById('errorDetail').textContent = error.message;
                errorDiv.classList.remove('hidden');
                // Render an empty table if the fetch fails
                renderTable([]);
            } finally {
                loading.classList.add('hidden');
            }
        };

        // Initialize the dashboard on page load
        window.onload = fetchCompanies;

    </script>
    <main class="container-padding mx-auto max-w-7xl mt-4">
        </main>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5', // indigo-600
                        'success': '#10b981', // emerald-500
                        'error': '#ef4444',   // red-500
                    }
                }
            }
        }
    </script>
        <script src="navbar.js"></script> 
    
</body>
</html>