<!-- 
    Filename: index.html
    Last Edited: 2025-10-24
    Purpose: Primary landing page/dashboard for viewing, filtering, and sorting standardized company profiles.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Data Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for sorting arrows -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Inter font setup and custom styles */
        html { font-family: 'Inter', sans-serif; }
        .sortable-header {
            cursor: pointer;
            user-select: none;
        }
        .container-height {
            min-height: calc(100vh - 8rem); 
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5', /* Indigo 600 */
                        'success': '#10b981',
                        'info': '#3b82f6',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Global Navigation Bar -->
    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex-shrink-0 flex items-center">
                    <span class="text-xl font-bold text-primary">Contact Data Dashboard</span>
                </div>
                <nav class="flex space-x-4">
                    <a href="index.html" class="bg-primary text-white px-3 py-2 rounded-lg text-sm font-medium" aria-current="page">
                        <i data-lucide="layout-dashboard" class="w-4 h-4 inline-block mr-1"></i> Dashboard
                    </a>
                    <a href="cleanup.html" class="text-gray-600 hover:text-primary px-3 py-2 rounded-lg text-sm font-medium transition duration-150">
                        <i data-lucide="link-2" class="w-4 h-4 inline-block mr-1"></i> Cleanup (Mapping)
                    </a>
                    <a href="management.html" class="text-gray-600 hover:text-primary px-3 py-2 rounded-lg text-sm font-medium transition duration-150">
                        <i data-lucide="briefcase" class="w-4 h-4 inline-block mr-1"></i> Management
                    </a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 container-height">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6 flex items-center">
            Standardized Company List
        </h1>

        <!-- Filter Controls -->
        <div class="bg-white shadow-lg rounded-xl p-4 mb-8 flex flex-col sm:flex-row gap-4 items-stretch">
            <div class="flex-grow">
                <label for="searchFilter" class="block text-sm font-medium text-gray-700 mb-1">Search Company Name</label>
                <input type="text" id="searchFilter" placeholder="Live search by clean name..." 
                       class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
            </div>
            <div>
                <label for="targetFilter" class="block text-sm font-medium text-gray-700 mb-1">Target Interest</label>
                <select id="targetFilter" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary bg-white">
                    <option value="all">Show All</option>
                    <option value="true">Target: Yes (★)</option>
                    <option value="false">Target: No</option>
                </select>
            </div>
        </div>

        <!-- Company Data Table -->
        <div class="bg-white shadow-lg rounded-xl overflow-hidden">
            <div id="loadingIndicator" class="text-center p-8 text-xl font-medium text-primary">
                <i data-lucide="loader-circle" class="w-6 h-6 inline-block animate-spin mr-2"></i> Loading Company Data...
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <!-- Company Name (Sortable) -->
                            <th scope="col" data-column="company_name_clean" class="sortable-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <div class="flex items-center">
                                    Name 
                                    <span class="sort-icon ml-1" data-icon-for="company_name_clean"><i data-lucide="arrow-down-up" class="w-3 h-3 text-gray-400"></i></span>
                                </div>
                            </th>
                            
                            <!-- Target Interest (Fixed) -->
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Target
                            </th>
                            
                            <!-- Employees (Sortable) -->
                            <th scope="col" data-column="size_employees" class="sortable-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <div class="flex items-center">
                                    Employees 
                                    <span class="sort-icon ml-1" data-icon-for="size_employees"><i data-lucide="arrow-down-up" class="w-3 h-3 text-gray-400"></i></span>
                                </div>
                            </th>
                            
                            <!-- Annual Revenue (Sortable) -->
                            <th scope="col" data-column="annual_revenue" class="sortable-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <div class="flex items-center">
                                    Annual Revenue 
                                    <span class="sort-icon ml-1" data-icon-for="annual_revenue"><i data-lucide="arrow-down-up" class="w-3 h-3 text-gray-400"></i></span>
                                </div>
                            </th>
                            
                            <!-- Headquarters (Sortable) -->
                            <th scope="col" data-column="headquarters" class="sortable-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <div class="flex items-center">
                                    HQ Location 
                                    <span class="sort-icon ml-1" data-icon-for="headquarters"><i data-lucide="arrow-down-up" class="w-3 h-3 text-gray-400"></i></span>
                                </div>
                            </th>
                            
                            <!-- Notes (Fixed) -->
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Notes
                            </th>
                        </tr>
                    </thead>
                    <tbody id="companyTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Data rows will be injected here by script -->
                    </tbody>
                </table>
            </div>
            <div id="noDataMessage" class="text-center p-8 text-gray-500 hidden">
                No company data available or no results match your current filter.
            </div>
        </div>
    </main>

    <!-- JavaScript Logic -->
    <script>
        const API_BASE = '/api';
        let allCompanies = [];
        let sortState = {
            column: 'company_name_clean',
            direction: 'asc' // 'asc' or 'desc'
        };

        const elements = {
            tableBody: document.getElementById('companyTableBody'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            noDataMessage: document.getElementById('noDataMessage'),
            searchFilter: document.getElementById('searchFilter'),
            targetFilter: document.getElementById('targetFilter')
        };

        /**
         * Custom sort function for the company list.
         * Handles string, number, and null/undefined values correctly.
         * @param {string} column - The key to sort by.
         * @param {string} direction - 'asc' or 'desc'.
         */
        function sortCompanies(companies, column, direction) {
            return companies.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                // Treat null/undefined/empty string as smallest values for sorting
                const isANull = valA === null || valA === undefined || valA === '';
                const isBNull = valB === null || valB === undefined || valB === '';

                if (isANull && isBNull) return 0;
                if (isANull) return direction === 'asc' ? -1 : 1; // Put nulls first in ASC, last in DESC
                if (isBNull) return direction === 'asc' ? 1 : -1; // Put nulls first in ASC, last in DESC

                let comparison = 0;
                
                // Numeric comparison
                if (typeof valA === 'number' && typeof valB === 'number') {
                    comparison = valA - valB;
                } 
                // String comparison (case-insensitive)
                else {
                    comparison = String(valA).toLowerCase().localeCompare(String(valB).toLowerCase());
                }

                return direction === 'asc' ? comparison : -comparison;
            });
        }

        /**
         * Filters the main company list based on current UI inputs.
         * @param {Array} list - The list of companies to filter.
         * @returns {Array} - The filtered list.
         */
        function filterCompanies(list) {
            const searchTerm = elements.searchFilter.value.toLowerCase();
            const targetFilterValue = elements.targetFilter.value;

            return list.filter(company => {
                // 1. Search Filter
                const matchesSearch = !searchTerm || company.company_name_clean.toLowerCase().includes(searchTerm);

                // 2. Target Filter
                const isTarget = company.target_interest === true;
                const matchesTarget = targetFilterValue === 'all' || 
                                      (targetFilterValue === 'true' && isTarget) || 
                                      (targetFilterValue === 'false' && !isTarget);
                
                return matchesSearch && matchesTarget;
            });
        }

        /**
         * Renders the company data table based on current filters and sort state.
         */
        function renderCompanyTable() {
            elements.tableBody.innerHTML = '';
            
            // 1. Filter
            let filteredList = filterCompanies(allCompanies);
            
            // 2. Sort
            let sortedList = sortCompanies(filteredList, sortState.column, sortState.direction);

            // 3. Update UI
            if (sortedList.length === 0) {
                elements.noDataMessage.classList.remove('hidden');
                return;
            }
            elements.noDataMessage.classList.add('hidden');

            sortedList.forEach(company => {
                // Format Revenue (handling nulls)
                const revenueDisplay = company.annual_revenue && company.revenue_scale 
                    ? `$${company.annual_revenue.toLocaleString('en-US', {maximumFractionDigits: 1})}${company.revenue_scale}`
                    : 'N/A';

                // Format Employees (handling nulls)
                const employeesDisplay = company.size_employees ? company.size_employees.toLocaleString('en-US') : 'N/A';

                // Target Indicator
                const targetIndicator = company.target_interest 
                    ? '<span class="text-success font-bold">★ YES</span>' 
                    : '<span class="text-gray-400">NO</span>';

                const row = elements.tableBody.insertRow();
                row.className = 'hover:bg-gray-50 transition-colors';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${company.company_name_clean}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${targetIndicator}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employeesDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${revenueDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${company.headquarters || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate" title="${company.notes || ''}">${company.notes || 'No notes'}</td>
                `;
            });
            updateSortIcons();
        }

        /**
         * Updates the visual indicator on the currently sorted column.
         */
        function updateSortIcons() {
            document.querySelectorAll('.sort-icon').forEach(iconContainer => {
                const column = iconContainer.getAttribute('data-icon-for');
                iconContainer.innerHTML = ''; // Clear existing icon

                if (column === sortState.column) {
                    const iconName = sortState.direction === 'asc' ? 'chevron-up' : 'chevron-down';
                    iconContainer.innerHTML = `<i data-lucide="${iconName}" class="w-4 h-4 text-primary"></i>`;
                } else {
                    iconContainer.innerHTML = `<i data-lucide="arrow-down-up" class="w-3 h-3 text-gray-400"></i>`;
                }
            });
            lucide.createIcons(); // Re-render Lucide icons
        }

        /**
         * Event handler for clickable table headers.
         */
        function handleSortClick(e) {
            const header = e.currentTarget;
            const column = header.getAttribute('data-column');

            if (sortState.column === column) {
                // Toggle direction
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // Change column, default to ascending
                sortState.column = column;
                sortState.direction = 'asc';
            }
            renderCompanyTable();
        }

        /**
         * Fetches all standardized company profiles from the backend (API Reference 2.1).
         */
        async function fetchCompanies() {
            elements.loadingIndicator.classList.remove('hidden');
            try {
                // Assuming API Reference 2.1: GET /api/companies
                const response = await fetch(`${API_BASE}/companies`);
                const data = await response.json();
                
                if (data.companies) {
                    allCompanies = data.companies;
                    renderCompanyTable();
                } else {
                    throw new Error(data.message || 'Data structure error.');
                }
            } catch (error) {
                console.error('Error fetching companies:', error);
                elements.loadingIndicator.innerHTML = `<i data-lucide="alert-triangle" class="w-6 h-6 inline-block mr-2 text-error-red"></i> Error loading data: ${error.message}`;
                elements.loadingIndicator.classList.add('text-error-red/80');
                elements.tableBody.innerHTML = '';
            } finally {
                elements.loadingIndicator.classList.add('hidden');
            }
        }

        // --- Event Listeners and Initialization ---

        window.onload = function() {
            // Initialize Lucide icons
            lucide.createIcons();
            
            // Attach sort click handlers to headers
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', handleSortClick);
            });

            // Attach filter change handlers
            elements.searchFilter.addEventListener('input', renderCompanyTable);
            elements.targetFilter.addEventListener('change', renderCompanyTable);
            
            // Initial data fetch
            fetchCompanies();
        };

    </script>
</body>
</html>
