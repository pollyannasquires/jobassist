<!-- FILENAME: index.html | LAST EDITED: 2025-11-24 (WITH SIDEBAR INTEGRATION) -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JobAssist | Company Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc; /* Light background for the dashboard */
        }
        /* Style for the main container that holds the sidebar and content */
        .app-layout-container {
            /* Sets the container height to the remaining viewport height (below the 64px navbar) */
            height: calc(100vh - 64px); 
            margin-top: 64px; /* Offset for the fixed navbar */
        }
        .container-padding {
            padding: 1.5rem 1rem;
        }
        @media (min-width: 640px) {
            .container-padding {
                padding: 2.5rem 2rem;
            }
        }
        .loading-animation {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5; /* Primary spinner color (indigo-600) */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Table column widths */
        .company-name-col {
            width: 200px;
            min-width: 200px;
        }
        .employee-size-col {
            width: 140px;
            min-width: 140px;
        }
        .revenue-col {
            width: 160px;
            min-width: 160px;
        }
        .apps-col {
            width: 120px;
            min-width: 120px;
        }
        .contacts-col {
            width: 120px;
            min-width: 120px;
        }
        .target-col {
            width: 140px;
            min-width: 140px;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- The Navigation Bar will be injected here by navbar.js (fixed top) -->

    <!-- New: Main Layout Container (Sidebar + Content) -->
    <!-- flex-1 and overflow-hidden ensures the components manage their scroll within this area -->
    <div class="flex app-layout-container overflow-hidden">
        
        <!-- 1. Sidebar Placeholder (Injected by dashboard_sidebar.js) -->
        <!-- The w-64, flex-shrink-0, and overflow-y-auto are crucial here -->
        <div id="sidebar-container" class="w-64 flex-shrink-0 overflow-y-auto bg-white border-r border-gray-200">
            <!-- Sidebar content goes here -->
        </div>

        <!-- 2. Main Dashboard Content Area -->
        <main id="dashboard-content" class="flex-1 overflow-y-auto">
            <div class="container-padding max-w-7xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Company Dashboard</h2>
                <p class="text-gray-600 mb-8">Overview of all standardized company profiles and enriched data. Click a **Clean Name** to go to the Management page.</p>

                <!-- Main Data Container -->
                <div class="bg-white shadow-xl rounded-xl overflow-hidden">
                    <div id="loadingMessage" class="flex justify-center items-center p-10 hidden">
                        <div class="loading-animation mr-3"></div>
                        <p class="text-gray-500">Loading company data...</p>
                    </div>

                    <div id="errorMessage" class="text-red-600 bg-red-50 p-6 hidden">
                        <p class="font-bold">Error Loading Data:</p>
                        <p id="errorDetail"></p>
                    </div>

                    <!-- Table Container -->
                    <div class="overflow-x-auto overflow-y-auto max-h-[70vh]">
                        <table class="min-w-full divide-y divide-gray-200 border-collapse">
                            <thead class="bg-gray-50">
                                <tr>
                                    <!-- Company Name Column -->
                                    <th id="header-company_name_clean" scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer select-none hover:bg-gray-100 transition duration-150 company-name-col" onclick="sortTable('company_name_clean')">
                                        Clean Company Name
                                        <span class="sort-indicator text-gray-400 ml-1" data-column="company_name_clean"></span>
                                    </th>
                                    <!-- Employee Size Column -->
                                    <th id="header-size_employees" scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer select-none hover:bg-gray-100 transition duration-150 employee-size-col" onclick="sortTable('size_employees')">
                                        Employee Size
                                        <span class="sort-indicator text-gray-400 ml-1" data-column="size_employees"></span>
                                    </th>
                                    <!-- Annual Revenue Column -->
                                    <th id="header-annual_revenue" scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer select-none hover:bg-gray-100 transition duration-150 revenue-col" onclick="sortTable('annual_revenue')">
                                        Annual Revenue
                                        <span class="sort-indicator text-gray-400 ml-1" data-column="annual_revenue"></span>
                                    </th>
                                    <!-- UPDATED: Applications Column (Full name and click handler) -->
                                    <th id="header-application_count" scope="col" class="px-3 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer select-none hover:bg-gray-100 transition duration-150 apps-col" onclick="sortTable('application_count')">
                                        Applications
                                        <span class="sort-indicator text-gray-400 ml-1" data-column="application_count"></span>
                                    </th>
                                    <!-- Contacts Column -->
                                    <th id="header-contact_count" scope="col" class="px-3 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer select-none hover:bg-gray-100 transition duration-150 contacts-col" onclick="sortTable('contact_count')">
                                        Contacts
                                        <span class="sort-indicator text-gray-400 ml-1" data-column="contact_count"></span>
                                    </th>
                                    <!-- Target Interest Column -->
                                    <th id="header-target_interest" scope="col" class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer select-none hover:bg-gray-100 transition duration-150 target-col" onclick="sortTable('target_interest')">
                                        Target Interest
                                        <span class="sort-indicator text-gray-400 ml-1" data-column="target_interest"></span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="companyTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Data will be injected here by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <p id="noDataMessage" class="p-6 text-center text-gray-500 hidden">
                        No standardized company profiles found. Please use the Cleanup Tool to map raw names.
                    </p>
                </div>
            </div>
        </main>
    </div>

    <!-- Global Dependency: Lucide Icons (must be loaded before scripts use it) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Module Dependencies and Main Application Script -->
    <script type="module" src="navbar.js"></script>
    <!-- New Sidebar Dependency -->
    <script type="module" src="dashboard_sidebar.js"></script>


    <script type="module">
        // Import only the approved exported functions from core-utils
        import { initializeServices, fetchWithGuard, currentUserId } from './core-utils.js';
        
        // Import the approved exported functions
        import { injectNavbar } from './navbar.js'; 
        // CRITICAL FIX: The export name 'renderSidebar' is now correctly imported
        import { renderSidebar } from './dashboard_sidebar.js'; 

        // CRITICAL: MOCK USER IMPLEMENTATION 
        window.__userId = 'mock-user-428613';
        
        // State management for sorting
        let companyData = [];
        let currentSort = { column: 'company_name_clean', direction: 'asc' };

        // Utility: Formats a number with commas (e.g., 150000 -> 150,000)
        const formatNumber = (num) => {
            if (num === null || num === undefined) return 'N/A';
            return num.toLocaleString('en-US');
        };

        // Utility: Formats revenue (e.g., 5.2, 'B' -> $5.2 B)
        const formatRevenue = (revenue, scale) => {
            if (revenue === null || revenue === undefined) return 'N/A';
            return `$${revenue} ${scale || ''}`;
        };

        // Updates the visual indicators (arrows) in the table headers
        const updateSortIndicators = () => {
            document.querySelectorAll('.sort-indicator').forEach(span => {
                span.innerHTML = '';
            });

            const currentSpan = document.querySelector(`.sort-indicator[data-column="${currentSort.column}"]`);
            if (currentSpan) {
                currentSpan.innerHTML = currentSort.direction === 'asc' ? '&#9650;' : '&#9660;'; // Up/Down Triangles
            }
        };

        // Renders the data into the table body
        const renderTable = (data) => {
            const tbody = document.getElementById('companyTableBody');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                document.getElementById('noDataMessage').classList.remove('hidden');
                return;
            }
            document.getElementById('noDataMessage').classList.add('hidden');

            data.forEach(company => {
                const revenueDisplay = formatRevenue(company.annual_revenue, company.revenue_scale);
                const sizeDisplay = formatNumber(company.size_employees);
                const targetDisplay = company.target_interest
                    ? '<svg class="w-5 h-5 text-yellow-500 inline-block align-middle" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.695h3.462c.969 0 1.371 1.24.588 1.81l-2.817 2.042a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.817-2.042a1 1 0 00-1.175 0l-2.817 2.042c-.785.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.05 8.724c-.783-.57-.381-1.81.588-1.81h3.461a1 1 0 00.951-.695l1.07-3.292z" /></svg>' // Star Icon
                    : '';
                
                // Construct the link URL for applications
                // NOTE: Updated to use 'companyId' parameter name
                const applicationLink = `application_review.html?companyId=${company.company_id}&companyName=${encodeURIComponent(company.company_name_clean)}`;
                const applicationsCount = formatNumber(company.application_count);

                // Use insertRow() on the tbody, then insertCell() on the row.
                const row = tbody.insertRow();
                
                // Clean Company Name (Link to Management)
                let cellName = row.insertCell();
                cellName.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600 hover:text-blue-800 transition duration-150 cursor-pointer company-name-col';
                // NOTE: Updated to use 'companyId' parameter name
                const managementLink = `management.html?companyId=${company.company_id}&companyName=${encodeURIComponent(company.company_name_clean)}`;
                cellName.innerHTML = `<a href="${managementLink}" class="hover:underline">${company.company_name_clean}</a>`;

                // Employee Size
                let cellSize = row.insertCell();
                cellSize.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-700 employee-size-col';
                cellSize.textContent = sizeDisplay;

                // Annual Revenue
                let cellRevenue = row.insertCell();
                cellRevenue.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-700 revenue-col';
                cellRevenue.textContent = revenueDisplay;
                
                // UPDATED: Applications Count (as a link)
                let cellApps = row.insertCell();
                cellApps.className = 'px-3 py-4 whitespace-nowrap text-sm text-center font-medium apps-col';
                // Only create a link if the count is > 0
                if (company.application_count > 0) {
                     cellApps.innerHTML = `<a href="${applicationLink}" class="text-primary hover:underline font-bold">${applicationsCount}</a>`;
                } else {
                     cellApps.textContent = applicationsCount;
                }
                
                // Contacts Count
                let cellContacts = row.insertCell();
                cellContacts.className = 'px-3 py-4 whitespace-nowrap text-sm text-center contacts-col';
                cellContacts.textContent = formatNumber(company.contact_count);

                // Target Interest
                let cellTarget = row.insertCell();
                cellTarget.className = 'px-6 py-4 whitespace-nowrap text-sm text-center target-col';
                cellTarget.innerHTML = targetDisplay;
            });

            updateSortIndicators();
        };

        // Sorts the companyData array and re-renders the table
        window.sortTable = (column) => {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            companyData.sort((a, b) => {
                let valA, valB;
                const dir = currentSort.direction;
                
                // Helper to treat null/undefined values for sorting
                const getComparableValue = (item, prop) => {
                    const value = item[prop];
                    if (value === null || value === undefined) {
                        // For ascending, nulls go to the end (Infinity). For descending, nulls go to the beginning (-Infinity).
                        return dir === 'asc' ? Infinity : -Infinity;
                    }
                    return value;
                };

                // Special handling for revenue to combine numeric part and scale
                if (column === 'annual_revenue') {
                    const getComparableRevenue = (company) => {
                        const val = parseFloat(company.annual_revenue) || 0;
                        const scale = company.revenue_scale;
                        if (val === 0 || val === null || val === undefined) return getComparableValue(company, 'annual_revenue');
                        if (scale === 'K') return val * 1e3;
                        if (scale === 'M') return val * 1e6;
                        if (scale === 'B') return val * 1e9;
                        return val;
                    };
                    valA = getComparableRevenue(a);
                    valB = getComparableRevenue(b);
                } else {
                    // This handles all other columns: company_name_clean, size_employees, target_interest, application_count, contact_count
                    valA = getComparableValue(a, column);
                    valB = getComparableValue(b, column);
                }
                
                // Default comparison
                if (valA < valB) {
                    return dir === 'asc' ? -1 : 1;
                }
                if (valA > valB) {
                    return dir === 'asc' ? 1 : -1;
                }
                return 0;
            });

            renderTable(companyData);
        };

        /**
         * Main function to fetch company data from the API using the guarded utility.
         */
        const fetchCompanies = async () => {
            const loading = document.getElementById('loadingMessage');
            const errorDiv = document.getElementById('errorMessage');
            loading.classList.remove('hidden');
            errorDiv.classList.add('hidden');

            try {
                // Wait for Firebase Auth to be ready before calling the API
                if (!currentUserId) {
                   await new Promise(resolve => setTimeout(resolve, 50)); 
                }
                
                // Using the correct 4-argument syntax for fetchWithGuard
                const result = await fetchWithGuard('/api/companies', 'GET', 'Company Dashboard Data Fetch', {});

                if (result.status === 'success' && Array.isArray(result.companies)) {
                    companyData = result.companies;
                    // Initial sort by clean name (default)
                    window.sortTable(currentSort.column); 
                } else {
                    // Treat non-success or malformed data as an error
                    throw new Error(result.message || 'API returned a non-success status or malformed data.');
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                document.getElementById('errorDetail').textContent = error.message;
                errorDiv.classList.remove('hidden');
                // Render an empty table to clear any previous data and show 'No Data' message
                renderTable([]);
            } finally {
                loading.classList.add('hidden');
            }
        };

        /**
         * Orchestrates the application launch sequence.
         */
        const bootApplication = async () => {
            try {
                // 1. Initialize Firebase services and authenticate
                await initializeServices(); 

                // 2. Inject Navbar structure and set active link
                injectNavbar(); 
                
                // 3. Render the sidebar immediately
                renderSidebar();
                
                // 4. Fetch primary dashboard data
                await fetchCompanies();

            } catch (error) {
                console.error("Application Boot Error:", error);
                const errorDiv = document.getElementById('errorMessage');
                document.getElementById('errorDetail').textContent = `Failed to initialize application: ${error.message}`;
                errorDiv.classList.remove('hidden');
            }
        };


        // Start the application after the DOM is ready
        document.addEventListener('DOMContentLoaded', bootApplication);

    </script>
    
    <!-- Tailwind Config for Primary Color -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5', // indigo-600 (Used by Navbar)
                        'success': '#10b981', // emerald-500
                        'error': '#ef4444',   // red-500
                    }
                }
            }
        }
    </script>
    
</body>
</html>